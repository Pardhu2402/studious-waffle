{% extends "base.html" %}
{% block content %}
<style>
/* Glassy effect for all main content cards and backgrounds */
.bg-dark-800.rounded-xl,
.bg-dark-800.rounded-lg,
.bg-dark-800.p-8,
.bg-dark-800.p-6,
.bg-dark-800 {
  background: rgba(30, 41, 59, 0.35) !important;
  backdrop-filter: blur(8px);
}
</style>
<div class="py-6 px-2 sm:px-4 md:px-8">
    <div class="bg-dark-800 rounded-xl shadow-lg p-8 border border-dark-700">
        <!-- Page Header -->
        <div class="bg-dark-800 rounded-lg shadow-sm border border-dark-700 p-6 mb-6">
            <div class="flex items-center space-x-4">
                <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-lg overflow-hidden">
                    <svg class="w-8 h-8 text-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                </div>
                <div class="flex-1">
                    <h1 class="text-xl font-semibold text-white">Parental Engagement</h1>
                    <p class="text-gray-300">Send progress updates and activities to parents</p>
                </div>
            </div>
        </div>

        <!-- Parental Engagement Form -->
        <div class="bg-dark-800 rounded-lg shadow-sm border border-dark-700 p-6">
            <h2 class="text-lg font-semibold text-white mb-4">Send Parent Update</h2>
            <form id="parentalForm" class="space-y-4">
                <div>
                    <label for="studentName" class="block text-sm font-medium text-gray-300 mb-2">Student Name</label>
                    <input type="text" id="studentName" name="studentName" 
                           class="w-full px-3 py-2 border border-dark-600 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent bg-dark-700 text-white placeholder-gray-400"
                           placeholder="Enter student name" required>
                </div>
                
                <div>
                    <label for="updateType" class="block text-sm font-medium text-gray-300 mb-2">Update Type</label>
                    <select id="updateType" name="updateType" 
                            class="w-full px-3 py-2 border border-dark-600 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent bg-dark-700 text-white">
                        <option value="progress">Progress Report</option>
                        <option value="homework">Homework Update</option>
                        <option value="activity">Home Activity</option>
                        <option value="reminder">Reminder</option>
                    </select>
                </div>
                
                <div>
                    <label for="updateContent" class="block text-sm font-medium text-gray-300 mb-2">Message Content</label>
                    <textarea id="updateContent" name="updateContent" rows="4" 
                              class="w-full px-3 py-2 border border-dark-600 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent bg-dark-700 text-white placeholder-gray-400"
                              placeholder="Enter the message content for parents..." required></textarea>
                </div>
                
                <!-- Voice Input Section -->
                <div class="space-y-3">
                    <label class="block text-sm font-medium text-gray-300">Or speak your message:</label>
                    <div class="flex space-x-4">
                        <button type="button" id="startVoiceInput" class="bg-pink-600 hover:bg-pink-700 text-white px-4 py-2 rounded-lg transition-colors">
                            üé§ Start Voice Input
                        </button>
                        <button type="button" id="stopVoiceInput" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors hidden">
                            ‚èπ Stop Voice Input
                        </button>
                    </div>
                    <div id="voiceStatus" class="text-sm text-gray-400"></div>
                </div>
                
                <div>
                    <label for="language" class="block text-sm font-medium text-gray-300 mb-2">Language</label>
                    <select id="language" name="language" 
                            class="w-full px-3 py-2 border border-dark-600 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent bg-dark-700 text-white">
                        <option value="English">English</option>
                        <option value="Hindi">Hindi</option>
                        <option value="Telugu">Telugu</option>
                        <option value="Kannada">Kannada</option>
                    </select>
                </div>
                
                <button type="submit" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                    Send to Parent
                </button>
            </form>
        </div>

        <!-- Generated Message Display -->
        <div id="generatedMessage" class="hidden bg-dark-800 rounded-lg shadow-sm border border-dark-700 p-6 mt-6">
            <h3 class="text-lg font-semibold text-white mb-4">Generated Message</h3>
            <div id="messageContent" class="p-4 bg-pink-900/20 border border-pink-500/30 rounded-lg">
                <p id="messageText" class="text-gray-300"></p>
            </div>
            <div class="mt-4 flex space-x-2">
                <button id="copyMessage" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                    üìã Copy Message
                </button>
                <button id="sendMessage" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                    üì§ Send via SMS
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Voice input functionality
let voiceRecorder;
let voiceChunks = [];

document.getElementById('startVoiceInput').addEventListener('click', async function() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        // Specify the correct MIME type for WAV format
        const options = {
            mimeType: 'audio/wav',
            audioBitsPerSecond: 16000
        };
        
        // Fallback if WAV is not supported
        if (!MediaRecorder.isTypeSupported('audio/wav')) {
            options.mimeType = 'audio/webm';
        }
        
        voiceRecorder = new MediaRecorder(stream, options);
        voiceChunks = [];
        
        voiceRecorder.ondataavailable = (event) => {
            voiceChunks.push(event.data);
        };
        
        voiceRecorder.onstop = async () => {
            const audioBlob = new Blob(voiceChunks, { type: voiceRecorder.mimeType });
            const formData = new FormData();
            
            // Use the correct filename based on the MIME type
            const filename = voiceRecorder.mimeType === 'audio/wav' ? 'parental_voice.wav' : 'parental_voice.webm';
            formData.append('audio', audioBlob, filename);
            
            try {
                document.getElementById('voiceStatus').textContent = 'Processing voice...';
                
                const response = await fetch('/speech-to-text', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                if (data.text) {
                    document.getElementById('updateContent').value = data.text;
                    document.getElementById('voiceStatus').textContent = 'Voice transcribed: ' + data.text;
                } else {
                    document.getElementById('voiceStatus').textContent = 'Could not process voice. Please try again.';
                }
            } catch (error) {
                console.error('Error processing voice:', error);
                document.getElementById('voiceStatus').textContent = 'Error processing voice: ' + error.message;
            }
        };
        
        voiceRecorder.start();
        this.classList.add('hidden');
        document.getElementById('stopVoiceInput').classList.remove('hidden');
        document.getElementById('voiceStatus').textContent = 'Recording... Speak your message!';
        
    } catch (error) {
        console.error('Error accessing microphone:', error);
        alert('Unable to access microphone. Please check permissions.');
    }
});

document.getElementById('stopVoiceInput').addEventListener('click', function() {
    if (voiceRecorder && voiceRecorder.state === 'recording') {
        voiceRecorder.stop();
        voiceRecorder.stream.getTracks().forEach(track => track.stop());
        
        this.classList.add('hidden');
        document.getElementById('startVoiceInput').classList.remove('hidden');
        document.getElementById('voiceStatus').textContent = 'Processing...';
    }
});

document.getElementById('parentalForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const studentName = document.getElementById('studentName').value.trim();
    const updateType = document.getElementById('updateType').value;
    const updateContent = document.getElementById('updateContent').value.trim();
    const language = document.getElementById('language').value;
    
    if (!studentName || !updateContent) {
        alert('Please fill in all required fields.');
        return;
    }
    
    try {
        const response = await fetch('/parental/notify', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                student_name: studentName,
                report: updateContent,
                language: language
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Display generated message
            document.getElementById('messageText').textContent = data.message;
            document.getElementById('generatedMessage').classList.remove('hidden');
            
            // Scroll to the message
            document.getElementById('generatedMessage').scrollIntoView({ behavior: 'smooth' });
        } else {
            alert('Error: ' + (data.error || 'Failed to generate message'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});

// Copy message functionality
document.getElementById('copyMessage').addEventListener('click', function() {
    const messageText = document.getElementById('messageText').textContent;
    navigator.clipboard.writeText(messageText).then(() => {
        this.textContent = '‚úÖ Copied!';
        setTimeout(() => {
            this.textContent = 'üìã Copy Message';
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy: ', err);
        alert('Failed to copy message to clipboard');
    });
});

// Send message functionality (mock)
document.getElementById('sendMessage').addEventListener('click', function() {
    alert('SMS functionality would be integrated with a messaging service in production.');
});
</script>
{% endblock %} 